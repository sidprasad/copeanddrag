<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Cope and Drag – Minimal</title>

    <link rel="icon" type="image/svg+xml" href="/img/logo.svg">
    <link rel="stylesheet" href="/css/diagramstyle.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/spytial-core/dist/components/react-component-integration.css">

    <!-- d3 + React -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- WebCola + Graphlib fallbacks -->
    <script>
        function loadLocalGraphlib() {
            const script = document.createElement("script");
            script.src = "/js/libs/graphlib-dot.min.js";
            document.head.appendChild(script);
        }
        function loadLocalCola() {
            const script = document.createElement("script");
            script.src = "/js/libs/cola.js";
            document.head.appendChild(script);
        }
    </script>
    <script src="https://marvl.infotech.monash.edu/webcola/extern/graphlib-dot.min.js" onerror="loadLocalGraphlib()"></script>
    <script src="https://cdn.jsdelivr.net/npm/webcola@3.4.0/WebCola/cola.min.js" onerror="loadLocalCola()"></script>

    <!-- Core + components (provides CndCore/CnDCore and builder mount helpers) -->
    <script src="https://cdn.jsdelivr.net/npm/spytial-core/dist/browser/cnd-core-complete.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/spytial-core/dist/components/react-component-integration.global.js"></script>

    <!-- Local scripts -->
    <script src="/js/imgdownload.js" defer></script>
    <script src="/js/graphScripts.js"></script>
    <script src="/js/index.js" defer></script>

    <style>
        body { padding: 0.75rem; }
        #graph-container, #graph-compare-left, #graph-compare-right {
            display: block;
            width: 100%;
            height: 600px;
            max-width: 100%;
        }
        .status { margin: 0.5rem 0; padding: 0.35rem 0.6rem; border-radius: 4px; }
        .status.info { background: #eef3ff; color: #24355c; }
        .status.success { background: #e5f7ed; color: #1f5133; }
        .status.error { background: #fdecea; color: #6a1a17; }
        .textarea-label { display: flex; align-items: center; gap: 0.35rem; }
        .textarea-label button { padding: 0.15rem 0.35rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-light bg-light mb-3">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h4">Cope and Drag – Minimal</span>
            <div class="d-flex gap-2">
                <button id="cola" class="btn btn-primary">Apply Layout</button>
                <button id="diagramDownloadButton" class="btn btn-outline-secondary" onclick="downloadBundle();" title="Export Diagram">
                    Export
                </button>
                <a href="/import" class="btn btn-outline-secondary">Import</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div id="status" class="status info">Paste Alloy XML and CnD spec, then apply layout.</div>

        <div class="row g-3">
            <div class="col-lg-4">
                <div class="mb-2">
                    <div class="textarea-label">
                        <label for="alloydatum" class="form-label mb-0">Alloy XML (datum.xml)</label>
                        <button id="toggleAlloy" class="btn btn-sm btn-outline-secondary" type="button">Show/Hide</button>
                    </div>
                    <textarea id="alloydatum" class="form-control font-monospace" rows="10"></textarea>
                </div>

                <div class="mb-2">
                    <div class="textarea-label">
                        <span class="form-label mb-0">CnD Spec</span>
                        <button id="openBuilder" class="btn btn-sm btn-outline-secondary" type="button">Open Builder</button>
                    </div>
                    <div id="cndSpec" class="form-control font-monospace" style="min-height: 180px; white-space: pre-wrap;"></div>
                    <div id="webcola-cnd-container" class="mt-2"></div>
                </div>

                <div class="mb-2">
                    <label class="form-label" for="layoutFormat">Layout Strategy</label>
                    <select id="layoutFormat" class="form-select">
                        <option value="default" selected>Standard</option>
                        <option value="grid">Grid (Beta)</option>
                    </select>
                </div>

                <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="temporalToggle">
                    <label class="form-check-label" for="temporalToggle">Show temporal comparison</label>
                </div>

                <div id="temporal-overview" class="card d-none">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold">Temporal Trace</span>
                            <span class="text-muted small" id="temporal-loop-label"></span>
                        </div>
                        <div id="temporal-map" class="d-flex flex-wrap gap-1 mt-2"></div>
                        <div class="text-muted small">Click a state to focus its diagram.</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Diagram</span>
                        <button id="clearGraphBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                    </div>
                    <div class="card-body">
                        <webcola-cnd-graph 
                            id="graph-container"
                            layoutFormat="default"
                            aria-label="Graph visualization"></webcola-cnd-graph>
                    </div>
                </div>

                <div id="temporalview" class="card d-none">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>Temporal Compare</span>
                        <span class="text-muted small" id="temporal-pair-label"></span>
                    </div>
                    <div class="card-body">
                        <div id="temporal-compare-warning" class="alert alert-info py-2 px-3 d-none"></div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="small text-muted mb-1">State <span id="temporal-left-index">0</span></div>
                                <webcola-cnd-graph id="graph-compare-left" layoutFormat="default" aria-label="Temporal left"></webcola-cnd-graph>
                            </div>
                            <div class="col-md-6">
                                <div class="small text-muted mb-1">State <span id="temporal-right-index">1</span></div>
                                <webcola-cnd-graph id="graph-compare-right" layoutFormat="default" aria-label="Temporal right"></webcola-cnd-graph>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Reuse shared resolver if present
        window.getCndCore = window.getCndCore || (() => window.CndCore || window.CnDCore);

        let parsedAlloyXML = null;
        let instanceNumber = 0;

        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            if (!statusElement) return;
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        function syncHiddenSpec(text) {
            const hidden = document.getElementById('cndSpec');
            if (hidden) hidden.textContent = text || '';
        }

        function getLoopBackIndex() {
            if (typeof parsedAlloyXML?.loop !== 'undefined') {
                const loopVal = parseInt(parsedAlloyXML.loop, 10);
                if (!Number.isNaN(loopVal)) return loopVal;
            }
            const alloyDatum = document.getElementById('alloydatum')?.value || '';
            const match = alloyDatum.match(/loop=\"(\d+)\"/);
            return match ? parseInt(match[1], 10) : -1;
        }

        function renderTemporalOverview() {
            const overviewCard = document.getElementById('temporal-overview');
            const mapContainer = document.getElementById('temporal-map');
            const loopLabel = document.getElementById('temporal-loop-label');

            if (!overviewCard || !mapContainer) return;
            mapContainer.innerHTML = '';

            const numInstances = parsedAlloyXML?.instances?.length || 0;
            if (numInstances <= 1) {
                overviewCard.classList.add('d-none');
                return;
            }

            overviewCard.classList.remove('d-none');
            const loopBack = getLoopBackIndex();
            if (loopLabel) {
                loopLabel.textContent = loopBack >= 0 ? `Loop to state ${loopBack}` : 'No loopback detected';
            }

            for (let i = 0; i < numInstances; i++) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm ' + (i === instanceNumber ? 'btn-primary' : 'btn-outline-secondary');
                btn.textContent = i;
                btn.onclick = () => stateclick(i);
                mapContainer.appendChild(btn);
            }
        }

        function nextTemporalIndex() {
            const numInstances = parsedAlloyXML?.instances?.length || 0;
            if (numInstances === 0) return { current: 0, next: 0 };
            const proposedNext = instanceNumber + 1;
            if (proposedNext < numInstances) return { current: instanceNumber, next: proposedNext };
            const loopBack = getLoopBackIndex();
            if (loopBack >= 0 && loopBack < numInstances) return { current: instanceNumber, next: loopBack };
            return { current: instanceNumber, next: numInstances - 1 };
        }

        async function renderTemporalComparison() {
            const warning = document.getElementById('temporal-compare-warning');
            const leftLabel = document.getElementById('temporal-left-index');
            const rightLabel = document.getElementById('temporal-right-index');
            const pairLabel = document.getElementById('temporal-pair-label');

            const numInstances = parsedAlloyXML?.instances?.length || 0;
            if (!parsedAlloyXML || numInstances <= 1) {
                if (warning) {
                    warning.textContent = 'A temporal trace requires at least two states.';
                    warning.classList.remove('d-none');
                }
                return;
            }
            if (warning) warning.classList.add('d-none');

            const { current, next } = nextTemporalIndex();
            if (leftLabel) leftLabel.textContent = current;
            if (rightLabel) rightLabel.textContent = next;
            if (pairLabel) pairLabel.textContent = `(${current} → ${next})`;

            await window.GraphAPI.renderGraphForInstance('graph-compare-left', current, { storeLayout: false });
            await window.GraphAPI.renderGraphForInstance('graph-compare-right', next, { storeLayout: false });
        }

        window.stateclick = function(instanceIndex) {
            const newIdx = parseInt(instanceIndex, 10);
            if (Number.isNaN(newIdx) || !parsedAlloyXML?.instances) return;
            if (newIdx < 0 || newIdx >= parsedAlloyXML.instances.length) return;
            instanceNumber = newIdx;
            renderTemporalOverview();
            renderTemporalComparison();
        };

        async function handleSessionData(sessionId) {
            try {
                const response = await fetch(`/api/sterling-data/${sessionId}`);
                if (!response.ok) return;
                const data = await response.json();
                window.pendingSessionAlloyXml = data.alloydatum;
                window.pendingSessionCndSpec = data.cope || '';
                if (window.GraphAPI?.setDiagramInputs) {
                    window.GraphAPI.setDiagramInputs({
                        alloyXml: data.alloydatum,
                        cndSpec: data.cope || ''
                    });
                }
                syncHiddenSpec(data.cope || '');

                const core = window.getCndCore();
                if (core?.AlloyInstance?.parseAlloyXML && data.alloydatum) {
                    parsedAlloyXML = core.AlloyInstance.parseAlloyXML(data.alloydatum);
                    instanceNumber = 0;
                    renderTemporalOverview();
                }
            } catch (err) {
                console.error('Failed to load Sterling data:', err);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const toggleAlloyBtn = document.getElementById('toggleAlloy');
            const alloyTextarea = document.getElementById('alloydatum');
            const builderContainer = document.getElementById('webcola-cnd-container');
            const openBuilderBtn = document.getElementById('openBuilder');
            const temporalToggle = document.getElementById('temporalToggle');

            // Load stored data
            const storedAlloy = localStorage.getItem('alloyDatum') || '';
            const storedCnd = localStorage.getItem('cndSpec') || '';
            if (window.GraphAPI?.setDiagramInputs) {
                window.GraphAPI.setDiagramInputs({ alloyXml: storedAlloy, cndSpec: storedCnd }, { persist: false });
            }
            if (alloyTextarea && storedAlloy) alloyTextarea.value = storedAlloy;
            syncHiddenSpec(storedCnd);

            if (toggleAlloyBtn && alloyTextarea) {
                toggleAlloyBtn.addEventListener('click', () => {
                    alloyTextarea.classList.toggle('d-none');
                });
                alloyTextarea.addEventListener('input', (e) => {
                    window.GraphAPI?.setDiagramInputs?.({ alloyXml: e.target.value });
                });
            }

            if (builderContainer && window.mountCndLayoutInterface) {
                const config = {
                    initialYamlValue: storedCnd,
                    initialIsNoCodeView: false
                };
                window.mountCndLayoutInterface('webcola-cnd-container', config);
            }
            if (openBuilderBtn && builderContainer) {
                openBuilderBtn.addEventListener('click', () => {
                    builderContainer.scrollIntoView({ behavior: 'smooth' });
                });
            }

            // Button handlers
            document.getElementById('cola')?.addEventListener('click', async () => {
                try {
                    await window.GraphAPI.generateDiagram(instanceNumber);
                    parsedAlloyXML = window.parsedAlloyXML || parsedAlloyXML;
                    renderTemporalOverview();
                    if (temporalToggle?.checked) {
                        await renderTemporalComparison();
                    }
                    updateStatus('Diagram generated.', 'success');
                } catch (err) {
                    console.error(err);
                    updateStatus(err.message || 'Generation failed.', 'error');
                }
            });

            document.getElementById('layoutFormat')?.addEventListener('change', () => {
                window.GraphAPI.changeLayoutFormat();
            });

            document.getElementById('clearGraphBtn')?.addEventListener('click', () => {
                window.GraphAPI.clearGraph();
            });

            temporalToggle?.addEventListener('change', async (e) => {
                const temporalCard = document.getElementById('temporalview');
                if (e.target.checked) {
                    temporalCard?.classList.remove('d-none');
                    await renderTemporalComparison();
                } else {
                    temporalCard?.classList.add('d-none');
                }
            });

            // Initialize pipeline if available
            try {
                await window.GraphAPI.initializePipeline();
            } catch (err) {
                console.error('Pipeline init failed:', err);
                updateStatus('CndCore not loaded. Check network and reload.', 'error');
            }

            // Session handling
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (sessionId) {
                await handleSessionData(sessionId);
            }
        });

        window.addEventListener('beforeunload', () => {
            const alloyDatum = document.getElementById('alloydatum')?.value || '';
            const cndSpec = window.GraphAPI?.getCurrentCNDSpec?.() || '';
            localStorage.setItem('alloyDatum', alloyDatum);
            localStorage.setItem('cndSpec', cndSpec);
            localStorage.setItem('instanceNumber', instanceNumber);
        });
    </script>
</body>
</html>
