<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Cope and Drag</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />


    <!-- Include Bootstrap CSS, JQuery, etc -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>

    <link rel="icon" type="image/svg+xml" href="/img/logo.svg">
    <link rel="stylesheet" href="/css/diagramstyle.css">
    <link rel="stylesheet" href="/css/index.css">

    <script>
        function loadLocalGraphlib() {
            console.warn("CDN for graphlib-dot.min.js failed. Loading local copy...");
            const script = document.createElement("script");
            script.src = "/js/libs/graphlib-dot.min.js"; // Path to your local copy
            document.head.appendChild(script);
        }

        function loadLocalCola() {
            console.warn("CDN for cola.min.js failed. Loading local copy...");
            const script = document.createElement("script");
            script.src = "/js/libs/cola.js"; // Path to your local copy
            document.head.appendChild(script);
        }
    </script>
    <!-- Primary CDN -->
    <script src="https://marvl.infotech.monash.edu/webcola/extern/graphlib-dot.min.js" onerror="loadLocalGraphlib()"></script>
    <script src="https://cdn.jsdelivr.net/npm/webcola@3.4.0/WebCola/cola.min.js" onerror="loadLocalCola()"></script>

    <!-- Include d3 here -->
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <!-- React for components -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Include your custom JavaScript file -->
    <script src="/js/imgdownload.js" defer></script>
    <script src="/js/graphScripts.js" onerror="console.error('Failed to load graphScripts.js')"></script>
    <script src="/js/index.js" onerror="console.error('Failed to load index.js')"></script>

    <!-- Complete CND-Core browser bundle -->
    <script src="https://cdn.jsdelivr.net/npm/cnd-core@1.1.9/dist/browser/cnd-core-complete.global.js"></script>

    <!-- Demo components bundle (includes InstanceBuilder integration) -->
    <script src="https://cdn.jsdelivr.net/npm/cnd-core@1.1.9/dist/components/react-component-integration.global.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cnd-core@1.1.9/dist/components/react-component-integration.css">

    <!-- Include other JS libraries -->
    <script src="https://cdn.jsdelivr.net/npm/split.js/dist/split.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Mermaid loaded dynamically when needed -->

    <script>
        /** GLOBAL VARIABLES **/
        let parsedAlloyXML = null; // Parsed Alloy XML from Sterling data
        let instanceNumber = 0; // Zero-indexed number representing the instance being shown

        /**
         * Update status display with proper styling
         * @param {string} message - Status message to display
         * @param {string} type - Status type: 'info', 'success', 'error'
         */
        function updateStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        /**
         * Receive data from Sterling
         * @param {string} sessionId - Sterling session ID
         * @returns {Promise<void>}
         */
        async function handleSessionData(sessionId) {
            try {
                const response = await fetch(`/api/sterling-data/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    
                    // Parse the current Alloy XML
                    const alloyXML = data.alloydatum;
                    if (!alloyXML) {
                        throw new Error('Alloy datum not found in Sterling data');
                    }
                    if (!CndCore.AlloyInstance.parseAlloyXML) {
                        throw new Error('AlloyInstance.parseAlloyXML is not available in CndCore');
                    }

                    // Initialize global variables
                    console.log('Parsing Alloy XML...');
                    parsedAlloyXML = CndCore.AlloyInstance.parseAlloyXML(alloyXML);
                    instanceNumber = 0; // Reset to first instance
                    console.log('Parsed Alloy XML:', parsedAlloyXML);
                    
                    // Populate forms with Sterling data
                    const alloyTextarea = document.getElementById('alloydatum');
                    if (alloyTextarea) {
                        alloyTextarea.value = alloyXML;
                    }

                    // Mount the CnDLayoutInterface component with initial YAML value
                    if (window.mountCndLayoutInterface) {
                        const config = {
                            initialYamlValue: data.cope,
                            initialIsNoCodeView: false
                        };
                        window.mountCndLayoutInterface("webcola-cnd-container", config);
                        console.log('CnDLayoutInterface mounted.');
                    } else {
                        console.error('Error: mountCndLayoutInterface is not available.');
                    }

                    // Render temporal minimap after data is loaded
                    await renderTemporalMinimap();
                    renderNavigationButtons();
                    
                    // Clean URL
                    window.history.replaceState({}, '', '/');
                }
            } catch (error) {
                console.error('Failed to load Sterling data:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            // Split the screen into two resizable columns
            Split(['#exploreCol', '#instanceCol', '#controlsCol']);

            // This is the text area input for the Alloy datum.
            var alloyInstanceLabel = document.getElementById('alloyinstancelabel');
            var alloyDatumTextarea = document.getElementById('alloydatum');

            // Fill the Alloy datum textarea with the current Alloy datum
            if (alloyDatumTextarea) {
                alloyDatumTextarea.value = localStorage.getItem('alloyDatum') || '';
            }

            // Add onClick event listener to the Alloy Instance label
            alloyInstanceLabel.addEventListener('click', function () {
                if (alloyDatumTextarea.style.display === 'none') {
                    alloyDatumTextarea.style.display = 'block';
                } else {
                    alloyDatumTextarea.style.display = 'none';
                }
            });

            // Add onClick event listener to the "Apply Layout" button
            const submitButton = document.getElementById('cola');
            submitButton.addEventListener('click', async function (event) {
                console.log('Apply Layout button clicked');
                // Set the class of the button to spinner
                submitButton.classList.add('spinner-border', 'spinner-border-sm');
                submitButton.setAttribute('disabled', 'disabled'); // Disable the button

                // Add each projection control's value as a hidden input to the form
                // const projectionControls = document.querySelectorAll('[id$="_projection"]');

                // projectionControls.forEach(control => {
                //     const hiddenInput = document.createElement('input');
                //     hiddenInput.type = 'hidden';
                //     hiddenInput.name = control.name; // Use the control's name as the input name
                //     hiddenInput.value = control.value; // Use the control's value as the input value
                //     form.appendChild(hiddenInput);
                // });

                try {
                    // Use client-side generation instead of server submission
                    await window.GraphAPI.generateDiagram(instanceNumber);
                    
                    // Update temporal minimap after diagram generation
                    await renderTemporalMinimap();
                    renderNavigationButtons();

                    updateStatus('Diagram generated successfully', 'success');
                } catch (error) {
                    console.error('Diagram generation failed:', error);
                    updateStatus(`Generation failed: ${error.message}`, 'error');
                } finally {
                    submitButton.classList.remove('spinner-border', 'spinner-border-sm');
                    submitButton.removeAttribute('disabled');
                }
            });

            // Add event listeners to the tab views
            const tabs = document.querySelectorAll('#instanceTabs .nav-link');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    // Hide all tab contents
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // Add active class to the clicked tab
                    this.classList.add('active');

                    // Render the content of the tab
                    switch (this.getAttribute('data-target')) {
                        case '#svggraphview':
                            break;
                        case '#tableview':
                            renderTable(); // Render table when the tab is clicked
                            break;
                        case '#forgeinstview':
                            renderForgeInstance(); // Render Forge Instance when the tab is clicked
                            break;
                    }
                    
                    // Show the corresponding tab content
                    const target = document.querySelector(this.dataset.target);
                    if (target) {
                        target.style.display = 'block';
                    }
                });
            });
        });

        window.addEventListener('load', async () => {
            // Check for existence of global functions from cnd-core CDN
            if (window.CnDCore) {
                window.DataAPI = CnDCore.DataAPI;
                window.ErrorAPI = CnDCore.ErrorAPI;
                console.log('CnDCore loaded successfully.');
            } else {
                console.error('Error: CnDCore is not loaded. Please check that the proper version of cnd-core CDN (1.0.14 and above) is included.');
                return;
            }
            
            // Initialize the pipeline
            if (window.GraphAPI) {
                window.GraphAPI.initializePipeline();
                console.log('GraphAPI initialized.');

                // Initialize global variables
                if (localStorage.getItem('alloyDatum')) {
                    const alloyDatum = localStorage.getItem('alloyDatum');
                    parsedAlloyXML = CndCore.AlloyInstance.parseAlloyXML(alloyDatum);
                }

                if (localStorage.getItem('instanceNumber')) {
                    instanceNumber = parseInt(localStorage.getItem('instanceNumber'), 10);
                }
            }

            // Mount the CnDLayoutInterface component
            if (window.mountCndLayoutInterface) {
                window.mountCndLayoutInterface("webcola-cnd-container");
                console.log('CnDLayoutInterface mounted.');
            } else {
                console.error('Error: mountCndLayoutInterface is not available.');
            }

            // Mount the Error Message Modal component
            if (window.mountErrorMessageModal) {
                window.mountErrorMessageModal('error_messages');
                console.log('ErrorMessageModal mounted.');
            } else {
                console.warn('Warning: mountErrorMessageModal is not available.');
            }

            // Check for Sterling session data
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            
            if (sessionId) {
                await handleSessionData(sessionId);
                if (window.GraphAPI?.generateDiagram) {
                    // Auto-generate diagram if session data is available
                    await window.GraphAPI.generateDiagram(instanceNumber);
                } else {
                    console.warn('GraphAPI.generateDiagram is not available.');
                }
            }

            // Render the active tab on page load
            renderActiveTab();

            // Attempt to render temporal minimap on page load
            await renderTemporalMinimap();
            renderNavigationButtons();
        });

        window.addEventListener('beforeunload', (event) => {
            // Save the current Alloy datum to localStorage
            const alloyDatum = document.getElementById('alloydatum');
            if (alloyDatum) {
                localStorage.setItem('alloyDatum', alloyDatum.value);
            }

            // Save the current instance number to localStorage
            localStorage.setItem('instanceNumber', instanceNumber);
        });

        /** HELPER FUNCTIONS **/

        /**
         * Render the currently active tab based on the selected tab
         */
        function renderActiveTab() {
            const activeTab = document.querySelector('#instanceTabs .nav-link.active');
            if (activeTab) {
                const target = activeTab.getAttribute('data-target');
                switch (target) {
                    case '#svggraphview':
                        if (window.GraphAPI?.generateDiagram) {
                            console.log(`Rendering SVG graph view for instance ${instanceNumber}`);
                            window.GraphAPI.generateDiagram(instanceNumber);
                        }
                        break;
                    case '#tableview':
                        renderTable();
                        break;
                    case '#forgeinstview':
                        renderForgeInstance();
                        break;
                }
            }
        }

        /**
         * Render the Forge Instance as a String based on parsed Alloy XML.
         */
        function renderForgeInstance() {
            const forgeInstContainer = document.getElementById('forge-inst-container');
            forgeInstContainer.innerHTML = ''; // Clear previous content

            // Default element - when Forge Instance is not available, or empty
            const defaultElement = document.createElement('p');
            defaultElement.textContent = 'Instance Not Available';
            
            // Check if parsedAlloyXML is available and has instances
            if (!parsedAlloyXML || !parsedAlloyXML.instances || parsedAlloyXML.instances.length === 0) {
                forgeInstContainer.appendChild(defaultElement);
                return;
            }
            
            // Get the Forge Instance
            const instances = parsedAlloyXML.instances;
            if (!window.instanceToInst) {
                console.error('Error: instanceToInst function is not available.');
                forgeInstContainer.appendChild(defaultElement);
                return;
            }
            const forgeInstance = window.instanceToInst(instances[instanceNumber]);
            
            // Render the Forge Instance
            if (forgeInstance) {
                const forgeInstElement = document.createElement('code');
                forgeInstElement.style.whiteSpace = 'pre-wrap';
                const instAsString = JSON.stringify(forgeInstance).trim().replace(/^"|"$/g, '').replace(/\\n/g, '\n');
                forgeInstElement.textContent = instAsString;
                forgeInstContainer.appendChild(forgeInstElement);
            } else {
                forgeInstContainer.appendChild(defaultElement);
            }
        }

        /**
         * Render an HTML table based on parsed Alloy XML.
         */
        function renderTable() {
            const tableViewContainer = document.getElementById('table-view-container');
            tableViewContainer.innerHTML = ''; // Clear previous content

            // Default element - when table is not available, or empty
            const defaultElement = document.createElement('p');
            defaultElement.textContent = 'Table Not Available';

            // Check if parsedAlloyXML is available and has instances
            if (!parsedAlloyXML || !parsedAlloyXML.instances || parsedAlloyXML.instances.length === 0) {
                tableViewContainer.appendChild(defaultElement);
                return;
            }

            // Get the Forge Instance
            const instances = parsedAlloyXML.instances;
            if (!window.instanceToTables) {
                console.error('Error: instanceToTables function is not available.');
                tableViewContainer.appendChild(defaultElement);
                return;
            }
            const forgeTable = window.instanceToTables(instances[instanceNumber]);

            // Render the Forge Table
            if (forgeTable) {
                // Atoms section
                const atomsSection = document.createElement('div');
                atomsSection.className = "d-flex flex-wrap";
                Object.keys(forgeTable.atoms).forEach(atomType => {
                    if (Array.isArray(forgeTable.atoms[atomType])) {
                        const atomDiv = document.createElement('div');
                        atomDiv.className = 'table-wrapper';
                        
                        // Create table structure using DOM methods
                        const table = document.createElement('table');
                        table.className = 'compact-table';
                        
                        const thead = document.createElement('thead');
                        const headerRow = document.createElement('tr');
                        const headerCell = document.createElement('th');
                        headerCell.textContent = atomType;
                        headerRow.appendChild(headerCell);
                        thead.appendChild(headerRow);
                        table.appendChild(thead);
                        
                        const tbody = document.createElement('tbody');
                        forgeTable.atoms[atomType].forEach(a => {
                            const row = document.createElement('tr');
                            const cell = document.createElement('td');
                            cell.textContent = a;
                            row.appendChild(cell);
                            tbody.appendChild(row);
                        });
                        table.appendChild(tbody);
                        
                        atomDiv.appendChild(table);
                        atomsSection.appendChild(atomDiv);
                    } else {
                        const defaultMessage = document.createElement('p');
                        defaultMessage.textContent = `No data available for atom type: ${atomType}`;
                        atomsSection.appendChild(defaultMessage);
                    }
                });
                tableViewContainer.appendChild(atomsSection);

                // Relations section
                const relationsSection = document.createElement('div', { class: "d-flex flex-wrap" });
                Object.keys(forgeTable.relations).forEach(relationType => {
                    if (forgeTable.relations[relationType] && forgeTable.relations[relationType].length > 0) {
                        const relationDiv = document.createElement('div');
                        relationDiv.className = 'table-wrapper';

                        let tableHTML = `<table class="compact-table"><thead><tr><th>${relationType}</th></tr></thead><tbody>`;
                        forgeTable.relations[relationType].forEach(r => {
                            tableHTML += `<tr><td>${r}</td></tr>`;
                        });
                        tableHTML += '</tbody></table>';
                        relationDiv.innerHTML = tableHTML;

                        relationsSection.appendChild(relationDiv);
                    } else {
                        const defaultMessage = document.createElement('p');
                        defaultMessage.textContent = `No data available for relation type: ${relationType}`;
                        relationsSection.appendChild(defaultMessage);
                    }
                })
                tableViewContainer.appendChild(relationsSection);
            } else {
                tableViewContainer.appendChild(defaultElement);
            }
        }

        /**
         * Render temporal minimap only when multiple instances exist
         */
        async function renderTemporalMinimap() {
            const mermaidContainer = document.querySelector('.mermaid');
            if (!mermaidContainer) return;
        
            // Only render if multiple instances exist
            if (!parsedAlloyXML?.instances || parsedAlloyXML.instances.length <= 1) {
                mermaidContainer.innerHTML = '';
                return;
            }
        
            // Load Mermaid dynamically if not available
            if (!window.mermaid) {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
                await new Promise((resolve, reject) => {
                    script.onload = () => {
                        mermaid.initialize({ startOnLoad: false, securityLevel: 'loose' });
                        resolve();
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }
        
            const numInstances = parsedAlloyXML.instances.length;
            const loopBack = parsedAlloyXML.loopBack || -1; // Default to -1 if not defined

            let mermaidCode = 'graph LR;\n';
            
            // Generate nodes and connections
            for (let i = 0; i < numInstances; i++) {
                // Highlight the current instance
                const isHighlighted = i === instanceNumber;
                mermaidCode += `    A${i}((${i}))${isHighlighted ? ':::highlight' : ''};\n`;
                
                // Connect to the next instance
                if (i < numInstances - 1) {
                    mermaidCode += `    A${i} --> A${i + 1};\n`;
                }
                
                // Add click event for each node
                mermaidCode += `    click A${i} call stateclick("${i}");\n`;
            }
            
            if (loopBack >= 0 && loopBack < numInstances) {
                mermaidCode += `    A${numInstances - 1} --> A${loopBack};\n`;
            }
            
            // Add styling
            mermaidCode += '    classDef highlight fill:#f96,stroke:#333,stroke-width:2px;\n';
            
            // Clear existing content
            mermaidContainer.innerHTML = '';
            mermaidContainer.removeAttribute('data-processed');
            
            // Render the Mermaid diagram
            try {
                if (mermaid.render) {
                    const { svg } = await mermaid.render(`mermaid-temporal-map-${Date.now()}`, mermaidCode);
                    mermaidContainer.innerHTML = svg;
                } else {
                    mermaidContainer.innerHTML = mermaidCode;
                    mermaid.init(undefined, mermaidContainer);
                }
            } catch (error) {
                mermaidContainer.innerHTML = '<p class="text-danger">Rendering failed</p>';
            }

            mermaidContainer.hidden = false; // Ensure the container is visible
        }
        
        /**
         * Handle state click in temporal minimap
         */
        window.stateclick = async function(instanceIndex) {
            const newInstanceNumber = parseInt(instanceIndex, 10);
            
            if (newInstanceNumber >= 0 && parsedAlloyXML?.instances && newInstanceNumber < parsedAlloyXML.instances.length) {
                instanceNumber = newInstanceNumber;
                await renderTemporalMinimap();
                renderNavigationButtons();
                
                // Regenerate the current view
                renderActiveTab();
            }
        };
        
        function renderNavigationButtons() {
            const prevButton = document.getElementById('previnstance');
            const nextButton = document.getElementById('nextinstance');
            
            if (!parsedAlloyXML?.instances) {
                if (prevButton) prevButton.disabled = true;
                if (nextButton) nextButton.disabled = true;
                return;
            }
            
            const numInstances = parsedAlloyXML.instances.length;
            
            if (prevButton) {
                prevButton.disabled = instanceNumber <= 0;
                prevButton.hidden = numInstances <= 1; // Hide if only one instance
                prevButton.innerHTML = '&lt;&lt;';
                prevButton.onclick = () => {
                    if (instanceNumber > 0) {
                        window.stateclick(instanceNumber - 1);
                    }
                };
            }
            
            if (nextButton) {
                nextButton.disabled = instanceNumber >= numInstances - 1;
                nextButton.hidden = numInstances <= 1; // Hide if only one instance
                nextButton.innerHTML = '&gt;&gt;';
                nextButton.onclick = () => {
                    if (instanceNumber < numInstances - 1) {
                        window.stateclick(instanceNumber + 1);
                    }
                };
            }
        }

    </script>

    <style>
        body {
            padding: 0.5rem;
        }

        /* Hide elements with the hidden class */
        .hidden {
            display: none !important;
        }

        .split {
            display: flex;
            flex-direction: row;
        }

        .gutter {
            background-color: #eee;
            background-repeat: no-repeat;
            background-position: 50%;
        }

        .gutter.gutter-horizontal {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bMfxAGAgYYmwGrIIiDjrELjpo5aiZeMwF+yNnOs5KSvgAAAABJRU5ErkJggg==');
            cursor: col-resize;
        }

        /** Explore Column Styles **/
        .temporalminimap-scroll-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            overflow-x: auto;
            background: #fff;
            box-sizing: border-box;
        }

        .mermaid {
            display: inline-block;
            min-width: max-content;
            margin: 1rem;
            background: #fff;
            box-sizing: border-box;
            white-space: wrap;
        }

        /* Additional styles for navigation buttons */
        #previnstance, #nextinstance {
            margin: 0 5px;
            padding: 5px 10px;
        }

        #previnstance:disabled, #nextinstance:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    
        /** Table Styles **/

        /* Flexbox for compact layout */
        .d-flex {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping to the next line if tables don't fit */
            gap: 1rem; /* Add spacing between tables */
        }

        .table-wrapper {
            flex: 1 1 auto; /* Allow tables to shrink and grow as needed */
            max-width: 300px; /* Optional: Set a max width for each table */
        }

        /* Compact table styling */
        .compact-table th,
        .compact-table td {
            padding: 0.25rem; /* Reduce padding inside cells */
            font-size: 0.9rem; /* Slightly smaller font size */
        }

        .compact-table {
            margin-bottom: 0.5rem; /* Reduce space between tables */
            border-collapse: collapse;
        }

        .compact-table th,
        .compact-table td {
            border: 1px solid #ddd; /* Light border for better readability */
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light">
        <div class="row w-100">
            <div class="col">
                <h4 class="navbar-brand">Cope and Drag</h4>
            </div>

            <div class="col">
                <!-- Button Group -->
                <div class="btn-group mp-2" role="group">
                    <!-- Download Diagram Button -->
                    <button id="diagramDownloadButton" class="btn btn-outline-secondary m-0" onclick="downloadBundle();" title="Export Diagram">
                        Export Diagram
                    </button>

                    <!-- Docs Button -->
                    <a href="https://sidprasad.github.io/copeanddrag/" target="_blank" class="btn btn-outline-secondary mp-2" title="Docs">
                        Docs
                    </a>

                    <!-- Docs Button -->
                    <a href="/openapi" target="_blank" class="btn btn-outline-secondary mp-2" title="API Details">
                        API Details
                    </a>
                </div>
            </div>
        </div>
    </nav>
    <div class="container m4" id="error_container">
        <div id="error_messages">
            <!-- React component mounted here -->
        </div>
    </div>

    <div class="split" id="contentcontainer">
        <!-- Columns for Split.js -->
        <!-- TODO: Explore col -->
        <div id="exploreCol">
            <div class="row mt-1">
                <div class="temporalminimap-scroll-container">
                    <div class="btn-group" role="group" aria-label="Instance navigation">
                        <button id="previnstance" disabled hidden></button>
                        <button id="nextinstance" disabled hidden></button>
                    </div>
                    <div class="mermaid" title="Click on any trace state to see its graph." hidden>
                        <!-- Mermaid diagram will be rendered here -->
                    </div>
                </div>
            </div>

            <div class="row mt-1">
                <div id="compactnessControl" class="container">
                    <input
                        title="Select the Diagram Compactness"
                        type="range"
                        class="form-control-range"
                        id="scaleFactor"
                        name="scaleFactor"
                        min="0.5"
                        max="10"
                        step="0.5"
                        value="<%= typeof scaleFactor !== 'undefined' ? scaleFactor : 5 %>">
                </div>
            </div>

            <div class="row mt-1">
                <div id="layoutControl" class="container">
                    <div class="input-group">
                        <pre class="input-group-text">Layout Strategy</pre>
                        <select title="Choose the Layout Format" class="form-control" id="layoutFormat" name="layoutFormat">
                            <option value="default" selected>Standard</option>
                            <option value="grid">Grid (Beta)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div id="instanceCol">
            <div class="container-fluid" id="instanceviews">
                <!-- Nav Tabs -->
                <ul class="nav nav-tabs" id="instanceTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-target="#svggraphview" href="#!">Diagram</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="#tableview" href="#!">Table</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-target="#forgeinstview" href="#!">Forge Instance</a>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div id="svggraphview" class="tab-content">
                    <!-- Use the webcola-cnd-graph custom element -->
                    <webcola-cnd-graph 
                        id="graph-container"
                        width="800" 
                        height="600"
                        layoutFormat="default"
                        aria-label="Interactive graph visualization">
                    </webcola-cnd-graph>
                </div>

                <div id="tableview" class="tab-content" style="display: none;">
                    <div id="table-view-container" class="container-fluid">
                        <!-- Table will be rendered here -->
                    </div>
                </div>
                <div id="forgeinstview" class="tab-content" style="display: none;">
                    <div id="forge-inst-container" class="container-fluid">
                        <!-- Forge Instance will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
        <div id="controlsCol">
            <div id="controls" class="col">
                <div class="d-flex flex-column gap-2 p-1">
                    <button id='cola' class="btn btn-primary btn-lg m-1 px-4">Apply Layout</button>
                    <hr>

                    <div id="status" class="status info">Ready to load Alloy graph...</div>
                    
                    <div id="webcola-cnd-container">
                        <!-- React component mounted here -->
                    </div>

                    <!-- And here, we are in actual controls terroir. -->

                    <br>
                    <div id="alloyDatumControlSection">
                        <label for="alloydatum" class="btn btn-outline-dark btn-sm" id="alloyinstancelabel"
                            style="cursor: pointer;">Edit Datum</label>
                        <textarea id="alloydatum" rows="5" name="alloydatum"
                            style="display: none;"></textarea>
                    </div>
                    <br>


                    <!-- Here, projections is a list of type { type : string, projectedAtom : string, atoms : string[]} 
                    If projections is non-empty, then show each type as a form input  and projectedAtom as the selected element of atoms
                    -->

                </div>
            </div>
        </div>
    </div>
</body>

</html>